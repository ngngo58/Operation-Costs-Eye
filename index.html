<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オペレーションコストEye - 統合版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    
    <style>
        /* --- 全体・基本スタイル --- */
        body {
            font-family: 'Meiryo', 'Hiragino Kaku Gothic ProN', 'MS PGothic', sans-serif;
            background-color: #f0f2f5;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- v21.2版由来のスタイル --- */
        .tab-active { background-color: #fff; color: #1e40af; border-bottom: 2px solid #1e40af; }
        .tab-inactive { background-color: #e5e7eb; color: #4b5563; }
        .input-group { margin-bottom: 1.25rem; position: relative; }
        .input-field { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .input-field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
        .result-card { background-color: #f9fafb; padding: 1.5rem; border-radius: 0.75rem; border: 1px solid #e5e7eb; }
        .result-value { font-size: 1.75rem; font-weight: 700; color: #111827; }
        .result-label { font-size: 0.875rem; color: #6b7285; margin-bottom: 0.25rem; }
        .badge { padding: 0.5rem 1rem; border-radius: 9999px; font-weight: 600; font-size: 1rem; }
        .badge-success { background-color: #dcfce7; color: #166534; }
        .badge-danger { background-color: #fee2e2; color: #991b1b; }
        .detail-item { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; }
        .detail-item-header { margin-bottom: 0.25rem; color: #6b7285; font-size: 0.875rem; font-weight: bold; }
        .btn-add { background-color: #e0e7ff; color: #3730a3; }
        .btn-add:hover { background-color: #c7d2fe; }
        .btn-delete { background-color: #fee2e2; color: #991b1b; flex-shrink: 0; }
        .btn-delete:hover { background-color: #fecaca; }
        .btn-clear-individual { position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); color: #9ca3af; cursor: pointer; padding: 0.25rem; z-index: 10; }
        .input-group input[type=number].input-field { padding-right: 2.5rem; }
        .btn-clear-individual:hover { color: #374151; }

        /* --- フリー版由来のスタイル (レイアウト崩れを防ぐため、親コンテナでスコープを限定) --- */
        #content-comparison .cost-item { display: flex; align-items: center; gap: 0.5rem; }
        #content-comparison .btn-delete { border-radius: 9999px; padding: 0.5rem; }
        #content-comparison .btn-add { width: 100%; padding: 0.75rem; font-weight: 600; border-radius: 0.5rem; }
        #content-comparison .total-card { background-color: #f9fafb; padding: 1rem 1.5rem; border-radius: 0.75rem; border: 1px solid #e5e7eb; }
        #content-comparison .total-value { font-size: 2.25rem; font-weight: 700; color: #1e40af; }
        #content-comparison .model-container { background-color: #ffffff; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); display: flex; flex-direction: column; gap: 1.5rem; }
        #content-comparison .comparison-summary { border: 2px solid #60a5fa; background-color: #eff6ff; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 500px; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <div class="flex justify-center items-center gap-4">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">オペレーションコストEye</h1>
                <button id="category-settings-btn" title="カテゴリ設定" class="p-2 rounded-full hover:bg-gray-200 transition hidden">
                    <svg class="w-6 h-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </div>
            <p id="app-description" class="text-gray-500 mt-2"></p>
        </header>

        <div id="capture-area" class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="flex border-b border-gray-200">
                <button id="tab-forward" class="flex-1 p-4 text-center font-semibold text-sm md:text-base transition tab-active">
                    積算モード
                </button>
                <button id="tab-backward" class="flex-1 p-4 text-center font-semibold text-sm md:text-base transition tab-inactive">
                    逆算モード
                </button>
                <button id="tab-comparison" class="flex-1 p-4 text-center font-semibold text-sm md:text-base transition tab-inactive">
                    比較分析モード
                </button>
            </div>

            <!-- 積算モード -->
            <div id="content-forward" class="p-6 md:p-8 fade-in">
                <div class="grid md:grid-cols-2 gap-8">
                     <!-- 入力エリア -->
                    <div>
                         <h2 class="text-xl font-bold text-gray-700 mb-6 border-l-4 border-blue-600 pl-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-700"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                            <span class="ml-2">入力項目</span>
                        </h2>
                        <div id="f-details-section"></div>
                        <h3 class="text-lg font-semibold text-gray-700 mt-8 mb-4">利益率の設定</h3>
                        <div class="input-group">
                            <label for="f-vendor-profit-rate" class="font-semibold text-gray-600 block mb-2 flex justify-between items-center">
                                <span>② 委託倉庫の利益率 (%)</span>
                                <span class="text-sm font-normal text-gray-400">(目安: 15～30%)</span>
                            </label>
                            <div class="relative">
                                <input type="number" id="f-vendor-profit-rate" class="input-field" value="15">
                                <button type="button" class="btn-clear-individual" data-target="f-vendor-profit-rate">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="f-my-profit-rate" class="font-semibold text-gray-600 block mb-2">④ 自社の確保したい利益率 (%)</label>
                            <div class="relative">
                                <input type="number" id="f-my-profit-rate" class="input-field" value="20">
                                <button type="button" class="btn-clear-individual" data-target="f-my-profit-rate">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- 計算結果エリア -->
                    <div>
                        <h2 class="text-xl font-bold text-gray-700 mb-6 border-l-4 border-green-600 pl-3 flex items-center">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-700"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                           <span class="ml-2">計算結果</span>
                        </h2>
                        <div class="space-y-6">
                            <div class="result-card">
                                <p class="result-label">① 作業原価 合計</p>
                                <p id="f-result-cost" class="result-value"></p>
                            </div>
                            <div class="result-card">
                                <p class="result-label">③ 倉庫への支払額 (① + ①×②)</p>
                                <p id="f-result-payment" class="result-value"></p>
                            </div>
                            <div class="result-card bg-blue-50 border-blue-200">
                                <p class="result-label">⑤ 最終請求額 (③ / (1 - ④))</p>
                                <p id="f-result-final-price" class="result-value text-blue-800"></p>
                                <p class="text-sm text-gray-600 mt-2">（内、自社利益: <span id="f-result-my-profit" class="font-semibold"></span>）</p>
                            </div>
                        </div>
                         <div class="mt-8">
                            <canvas id="f-labor-chart" style="max-height: 250px;"></canvas>
                        </div>
                        <div class="mt-8">
                            <canvas id="f-composition-chart" style="max-height: 250px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 逆算モード -->
            <div id="content-backward" class="p-6 md:p-8 hidden fade-in">
                 <div class="grid md:grid-cols-2 gap-8">
                    <!-- 入力エリア -->
                    <div>
                        <h2 class="text-xl font-bold text-gray-700 mb-6 border-l-4 border-blue-600 pl-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-700"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                            <span class="ml-2">入力項目</span>
                        </h2>
                        <div class="input-group">
                            <label for="b-price" class="font-semibold text-gray-600 block mb-2">① 顧客への請求単価 (円)</label>
                            <div class="relative">
                                <input type="number" id="b-price" class="input-field" value="100" step="5">
                                <button type="button" class="btn-clear-individual" data-target="b-price"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg></button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="b-my-profit-rate" class="font-semibold text-gray-600 block mb-2">② 自社の目標利益率 (%)</label>
                            <div class="relative">
                                <input type="number" id="b-my-profit-rate" class="input-field" value="20">
                                <button type="button" class="btn-clear-individual" data-target="b-my-profit-rate"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg></button>
                            </div>
                        </div>
                        <div id="b-details-section"></div>
                         <div class="input-group">
                            <label for="b-vendor-profit-rate" class="font-semibold text-gray-600 block mb-2 flex justify-between items-center">
                                <span>④ 委託倉庫の利益率 (%)</span>
                                <span class="text-sm font-normal text-gray-400">(目安: 15～30%)</span>
                            </label>
                            <div class="relative">
                                <input type="number" id="b-vendor-profit-rate" class="input-field" value="15">
                                <button type="button" class="btn-clear-individual" data-target="b-vendor-profit-rate"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg></button>
                            </div>
                        </div>
                    </div>
                    <!-- 計算結果エリア -->
                    <div>
                         <h2 class="text-xl font-bold text-gray-700 mb-6 border-l-4 border-green-600 pl-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-700"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                            <span class="ml-2">計算結果</span>
                         </h2>
                        <div class="space-y-6">
                            <div class="result-card">
                                <p class="result-label">③ 倉庫への支払予算 (① - ①×②)</p>
                                <p id="b-result-budget" class="result-value"></p>
                            </div>
                            <div class="result-card">
                                <p class="result-label">⑥ 交渉価格の目安 (③原価 + ③原価×④)</p>
                                <p id="b-result-payment" class="result-value"></p>
                            </div>
                             <div class="result-card bg-blue-50 border-blue-200">
                                <p class="result-label">⑦ 最終的な自社利益額 (① - ⑥)</p>
                                <p id="b-result-final-profit" class="result-value text-blue-800"></p>
                                <div id="b-result-badge-container" class="mt-3 text-center"></div>
                            </div>
                        </div>
                        <div class="mt-8">
                            <canvas id="b-labor-chart" style="max-height: 250px;"></canvas>
                        </div>
                        <div class="mt-8">
                            <canvas id="b-composition-chart" style="max-height: 250px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 比較分析モード -->
            <div id="content-comparison" class="p-4 md:p-8 hidden fade-in">
                <main class="grid lg:grid-cols-2 gap-8">
                    <!-- モデル A -->
                    <div id="model-a-container" class="model-container"></div>
                    <!-- モデル B -->
                    <div id="model-b-container" class="model-container"></div>
                </main>
                
                <!-- 比較セクション -->
                <section id="comparison-section" class="model-container hidden mt-8">
                     <div class="flex items-center justify-center gap-4">
                        <svg class="w-10 h-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" ><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" /></svg>
                        <h2 class="text-2xl font-bold text-gray-800 text-center">モデルA vs モデルB 比較分析</h2>
                        <svg class="w-10 h-10 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" ><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" /></svg>
                     </div>
                    <!-- 感度分析セクション -->
                    <div id="what-if-section" class="mt-6 p-4 border-t-2 border-dashed">
                        <h3 class="text-lg font-bold text-center text-gray-700 mb-3">感度分析 (What-if)</h3>
                        <div class="flex flex-wrap justify-center items-center gap-2">
                            <span>もし、</span>
                            <select id="what-if-category" class="input-field h-24" multiple></select>
                            <span>が</span>
                            <input type="number" id="what-if-percentage" class="input-field text-right w-24" placeholder="例: 10">
                            <span>%</span>
                            <select id="what-if-direction" class="input-field w-auto">
                                <option value="increase">上昇</option>
                                <option value="decrease">下落</option>
                            </select>
                            <span>したら？</span>
                            <button id="what-if-apply" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">分析を実行</button>
                            <button id="what-if-reset" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition">リセット</button>
                        </div>
                        <p class="text-xs text-gray-500 text-center mt-2">※ Ctrlキー(Macの場合はCommandキー)を押しながら項目をクリックすると、複数選択が可能です。</p>
                    </div>
                     <!-- 比較サマリー -->
                     <div id="comparison-summary" class="p-4 rounded-lg comparison-summary mt-6"></div>
                     <!-- 比較棒グラフ -->
                     <div class="mt-4">
                         <div class="flex items-center justify-center gap-3 my-4">
                            <svg class="w-8 h-8 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path></svg>
                            <h3 class="text-xl font-bold text-gray-700">カテゴリ別コスト比較</h3>
                            <svg class="w-8 h-8 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path></svg>
                         </div>
                         <canvas id="comparison-chart"></canvas>
                     </div>
                </section>
            </div>
        </div>
        
        <footer class="text-center mt-8 text-sm text-gray-400">
            <p>&copy; 2025 オペレーションコストEye. All Rights Reserved. <span id="version-info"></span></p>
        </footer>
    </div>
    
    <!-- カテゴリ設定モーダル (フリー版より移植) -->
    <div id="category-modal" class="modal-overlay hidden">
        <div class="modal-content space-y-4">
            <h2 class="text-xl font-bold">カテゴリ設定</h2>
            <div id="category-list" class="space-y-2 max-h-60 overflow-y-auto p-2 border rounded-md"></div>
            <div class="flex gap-2">
                <input type="text" id="new-category-name" class="input-field flex-grow" placeholder="新規カテゴリ名">
                <button id="add-category-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                    </svg>
                    <span>追加</span>
                </button>
            </div>
            <div class="flex justify-end gap-2 pt-4 border-t">
                <button id="save-categories-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">保存して閉じる</button>
                 <button id="cancel-categories-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">キャンセル</button>
            </div>
        </div>
    </div>

<script>
// --- Chart.jsのグローバル設定 ---
Chart.register(ChartDataLabels);
Chart.defaults.font.family = "'Meiryo', 'Hiragino Kaku Gothic ProN', 'MS PGothic', sans-serif";
Chart.defaults.plugins.datalabels.display = false;

// --- 共通・グローバル変数 ---
const formatCurrency = (value) => {
    const num = Math.round(value);
    return `¥${num.toLocaleString()}`;
};


// --- ここから v21.2版 (積算・逆算モード) のスクリプト ---
const v21_2 = (() => {
    const tabForward = document.getElementById('tab-forward');
    const tabBackward = document.getElementById('tab-backward');
    const tabComparison = document.getElementById('tab-comparison');
    
    const contentForward = document.getElementById('content-forward');
    const contentBackward = document.getElementById('content-backward');
    const contentComparison = document.getElementById('content-comparison');
    
    const categorySettingsBtn = document.getElementById('category-settings-btn');
    const appDescription = document.getElementById('app-description');
    const versionInfo = document.getElementById('version-info');

    const descriptions = {
        forward: '作業コストと利益率を入力し、顧客様への請求額をシミュレーションするツール',
        backward: '請求単価から、許容できる作業コストの予算をシミュレーションするツール',
        comparison: '異なるコストモデルを並べて、優劣を比較・分析シミュレーションツール'
    };

    // 逆算モードの要素
    const b_inputs = {
        price: document.getElementById('b-price'),
        myProfitRate: document.getElementById('b-my-profit-rate'),
        vendorProfitRate: document.getElementById('b-vendor-profit-rate'),
        detailsSection: document.getElementById('b-details-section')
    };
    const b_results = {
        budget: document.getElementById('b-result-budget'),
        payment: document.getElementById('b-result-payment'),
        finalProfit: document.getElementById('b-result-final-profit'),
        badgeContainer: document.getElementById('b-result-badge-container')
    };
    let b_labor_chart = null;
    let b_composition_chart = null;

    // 積算モードの要素
    const f_inputs = {
        vendorProfitRate: document.getElementById('f-vendor-profit-rate'),
        myProfitRate: document.getElementById('f-my-profit-rate'),
        detailsSection: document.getElementById('f-details-section')
    };
    const f_results = {
        cost: document.getElementById('f-result-cost'),
        payment: document.getElementById('f-result-payment'),
        finalPrice: document.getElementById('f-result-final-price'),
        myProfit: document.getElementById('f-result-my-profit')
    };
    let f_labor_chart = null;
    let f_composition_chart = null;

    const createDetailSectionHTML = (modePrefix) => {
    return `
        <h3 class="text-lg font-semibold text-gray-700 mt-8 mb-4">① 作業原価の内訳</h3>
        <div class="input-group">
            <label for="${modePrefix}-hourly-cost" class="font-semibold text-gray-600 block mb-2">スタッフ人時コスト (円/時)</label>
            <div class="relative">
                <input type="number" id="${modePrefix}-hourly-cost" class="input-field" value="1800" step="10">
                <button type="button" class="btn-clear-individual" data-target="${modePrefix}-hourly-cost"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg></button>
            </div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg mb-4">
            <div class="flex justify-between items-center mb-2 cursor-pointer" id="${modePrefix}-toggle-processes">
                <h4 class="font-semibold text-gray-800 flex justify-between items-center w-full">
                    <span>作業工程<span id="${modePrefix}-processes-total" class="text-sm font-normal text-gray-500 ml-2"></span></span>
                    <button type="button" class="text-xs text-red-500 hover:text-red-700 font-semibold section-clear-btn" data-target-list="${modePrefix}-processes-list">全削除</button>
                </h4>
                <span class="text-sm text-gray-500 transform transition-transform ml-2">▼</span>
            </div>
            <div id="${modePrefix}-processes-list"></div>
            <button type="button" id="${modePrefix}-add-process" class="mt-2 text-sm text-indigo-700 font-semibold hover:text-indigo-900">+ 作業工程を追加</button>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
            <div class="flex justify-between items-center mb-2 cursor-pointer" id="${modePrefix}-toggle-materials">
                <h4 class="font-semibold text-gray-800 flex justify-between items-center w-full">
                    <span>資材・経費<span id="${modePrefix}-materials-total" class="text-sm font-normal text-gray-500 ml-2"></span></span>
                    <button type="button" class="text-xs text-red-500 hover:text-red-700 font-semibold section-clear-btn" data-target-list="${modePrefix}-materials-list">全削除</button>
                </h4>
                <span class="text-sm text-gray-500 transform transition-transform ml-2">▼</span>
            </div>
            <div id="${modePrefix}-materials-list"></div>
            <button type="button" id="${modePrefix}-add-material" class="mt-2 text-sm text-indigo-700 font-semibold hover:text-indigo-900">+ 資材を追加</button>
        </div>
    `;
    };

    const setupDetailItems = (modePrefix, initialProcesses, initialMaterials) => {
        const detailsSection = document.getElementById(`${modePrefix}-details-section`);
        detailsSection.innerHTML = createDetailSectionHTML(modePrefix);
        
        if(modePrefix === 'b'){
            detailsSection.querySelector('h3').textContent = '③ 作業原価の内訳';
        }

        const processesList = document.getElementById(`${modePrefix}-processes-list`);
        const materialsList = document.getElementById(`${modePrefix}-materials-list`);
        const addProcessBtn = document.getElementById(`${modePrefix}-add-process`);
        const addMaterialBtn = document.getElementById(`${modePrefix}-add-material`);

        const addItem = (list, name, value, type) => {
            const item = document.createElement('div');
            item.className = 'detail-item';
            if (type === 'process') {
                item.innerHTML = `
                    <input type="text" class="input-field text-sm" style="flex-grow: 1; min-width: 0;" placeholder="項目名" value="${name}">
                    <input type="number" class="input-field text-sm process-input text-right" placeholder="秒" value="${value}" style="width: 70px; flex-shrink: 0;">
                    <span class="process-cost p-2 text-sm text-gray-700 text-right whitespace-nowrap" style="width: 85px; flex-shrink: 0;">¥0</span>
                    <button type="button" class="btn-delete" style="flex-shrink: 0;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button>
                `;
            } else { // material
                item.innerHTML = `
                    <input type="text" class="input-field text-sm" style="flex-grow: 1; min-width: 0;" placeholder="項目名" value="${name}">
                    <input type="number" class="input-field text-sm material-input text-right" placeholder="金額" value="${value}" style="width: 120px; flex-shrink: 0;">
                    <button type="button" class="btn-delete" style="flex-shrink: 0;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button>
                `;
            }
            list.appendChild(item);
            item.querySelectorAll('input').forEach(input => input.addEventListener('input', recalculate));
            item.querySelector('.btn-delete').addEventListener('click', () => { item.remove(); recalculate(); });
        };
        
        const processHeader = document.createElement('div');
        processHeader.className = 'detail-item detail-item-header';
        processHeader.innerHTML = `<span class="flex-grow">項目名</span><span style="width: 70px; flex-shrink: 0;" class="text-right">時間 (秒)</span><span style="width: 85px; flex-shrink: 0;" class="text-right">人件費</span><span style="width: 40px; flex-shrink: 0;"></span>`;
        processesList.appendChild(processHeader);

        addProcessBtn.addEventListener('click', () => { addItem(processesList, '', '', 'process'); recalculate(); });
        addMaterialBtn.addEventListener('click', () => { addItem(materialsList, '', '', 'material'); recalculate(); });
        
        document.getElementById(`${modePrefix}-toggle-processes`).addEventListener('click', (e) => {
            if (e.target.closest('.section-clear-btn')) return;
            processesList.classList.toggle('hidden'); addProcessBtn.classList.toggle('hidden'); e.currentTarget.querySelector('span:last-child').classList.toggle('rotate-180');
        });
        document.getElementById(`${modePrefix}-toggle-materials`).addEventListener('click', (e) => {
            if (e.target.closest('.section-clear-btn')) return;
            materialsList.classList.toggle('hidden'); addMaterialBtn.classList.toggle('hidden'); e.currentTarget.querySelector('span:last-child').classList.toggle('rotate-180');
        });
        
        detailsSection.querySelectorAll('.section-clear-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelectorAll(`#${btn.dataset.targetList} .detail-item:not(.detail-item-header)`).forEach(item => item.remove());
                recalculate();
            });
        });
        
        initialProcesses.forEach(p => addItem(processesList, p.name, p.value, 'process'));
        initialMaterials.forEach(m => addItem(materialsList, m.name, m.value, 'material'));
    };

    const getCostDetails = (modePrefix) => {
        const hourlyCost = parseFloat(document.getElementById(`${modePrefix}-hourly-cost`).value) || 0;
        const processDetails = Array.from(document.querySelectorAll(`#${modePrefix}-processes-list .detail-item:not(.detail-item-header)`)).map(item => {
            const name = item.querySelector('input[type="text"]').value || '無名の工程';
            const time = parseFloat(item.querySelector('.process-input').value) || 0;
            const cost = time * (hourlyCost / 3600);
            return { name, time, cost };
        });
        const materialDetails = Array.from(document.querySelectorAll(`#${modePrefix}-materials-list .detail-item`)).map(item => {
            const name = item.querySelector('input[type="text"]').value || '無名の資材';
            const cost = parseFloat(item.querySelector('.material-input').value) || 0;
            return { name, cost };
        });
        const totalWorkTime = processDetails.reduce((sum, p) => sum + p.time, 0);
        const laborCost = processDetails.reduce((sum, p) => sum + p.cost, 0);
        const totalMaterialCost = materialDetails.reduce((sum, m) => sum + m.cost, 0);
        const totalCost = laborCost + totalMaterialCost;
        return { totalCost, processDetails, materialDetails, totalWorkTime, totalMaterialCost, hourlyCost, laborCost };
    };

    const updateIndividualCostsAndTotals = (modePrefix, hourlyCost, totalWorkTime, totalMaterialCost, laborCost) => {
        const secondCost = hourlyCost / 3600;
        document.querySelectorAll(`#${modePrefix}-processes-list .detail-item:not(.detail-item-header)`).forEach(item => {
            const time = parseFloat(item.querySelector('.process-input')?.value) || 0;
            item.querySelector('.process-cost').textContent = formatCurrency(time * secondCost);
        });
        document.getElementById(`${modePrefix}-processes-total`).textContent = `(合計: ${totalWorkTime}秒 / ${formatCurrency(laborCost)})`;
        document.getElementById(`${modePrefix}-materials-total`).textContent = `(合計: ${formatCurrency(totalMaterialCost)})`;
    };

    function calculateBackward() {
        const price = parseFloat(b_inputs.price.value) || 0;
        const myProfitRate = (parseFloat(b_inputs.myProfitRate.value) || 0) / 100;
        const vendorProfitRate = (parseFloat(b_inputs.vendorProfitRate.value) || 0) / 100;
        const { totalCost, processDetails, materialDetails, totalWorkTime, totalMaterialCost, hourlyCost, laborCost } = getCostDetails('b');
        updateIndividualCostsAndTotals('b', hourlyCost, totalWorkTime, totalMaterialCost, laborCost);
        const myTargetProfit = price * myProfitRate;
        const budget = price - myTargetProfit;
        const vendorProfit = totalCost * vendorProfitRate;
        const paymentToVendor = totalCost + vendorProfit;
        const finalProfit = price - paymentToVendor;
        b_results.budget.textContent = formatCurrency(budget);
        b_results.payment.textContent = formatCurrency(paymentToVendor);
        b_results.finalProfit.textContent = formatCurrency(finalProfit);
        b_results.badgeContainer.innerHTML = finalProfit >= myTargetProfit ? `<span class="badge badge-success">目標利益 達成</span>` : `<span class="badge badge-danger">目標未達</span>`;
        updateLaborChart('b', processDetails);
        updateCompositionChart('b', { labor: laborCost, material: totalMaterialCost, vendorProfit: vendorProfit, ownProfit: finalProfit, finalPrice: price });
    }

    function calculateForward() {
        const vendorProfitRate = (parseFloat(f_inputs.vendorProfitRate.value) || 0) / 100;
        const myProfitRate = (parseFloat(f_inputs.myProfitRate.value) || 0) / 100;
        const { totalCost, processDetails, materialDetails, totalWorkTime, totalMaterialCost, hourlyCost, laborCost } = getCostDetails('f');
        updateIndividualCostsAndTotals('f', hourlyCost, totalWorkTime, totalMaterialCost, laborCost);
        const vendorProfit = totalCost * vendorProfitRate;
        const paymentToVendor = totalCost + vendorProfit;
        const finalPrice = myProfitRate >= 1 ? paymentToVendor : paymentToVendor / (1 - myProfitRate);
        const myProfit = finalPrice - paymentToVendor;
        f_results.cost.textContent = formatCurrency(totalCost);
        f_results.payment.textContent = formatCurrency(paymentToVendor);
        f_results.finalPrice.textContent = formatCurrency(finalPrice);
        f_results.myProfit.textContent = formatCurrency(myProfit);
        updateLaborChart('f', processDetails);
        updateCompositionChart('f', { labor: laborCost, material: totalMaterialCost, vendorProfit: vendorProfit, ownProfit: myProfit, finalPrice: finalPrice });
    }

    const updateLaborChart = (modePrefix, processDetails) => {
        const chartId = `${modePrefix}-labor-chart`;
        const ctx = document.getElementById(chartId).getContext('2d');
        let chartInstance = (modePrefix === 'b') ? b_labor_chart : f_labor_chart;
        const labels = processDetails.map(p => p.name);
        const data = processDetails.map(p => p.cost);
        const totalCost = data.reduce((a, b) => a + b, 0);
        if (chartInstance) chartInstance.destroy();
        const newChart = new Chart(ctx, { type: 'pie', data: { labels, datasets: [{ data, backgroundColor: ['#3B82F6', '#EF4444', '#F59E0B', '#10B981', '#8B5CF6', '#EC4899'], borderColor: '#fff', borderWidth: 2 }] }, options: { animation: false, responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, title: { display: true, text: `人件費の割合 (合計: ${formatCurrency(totalCost)})`, font: { size: 16 } }, tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatCurrency(ctx.raw)} (${totalCost > 0 ? (ctx.parsed / totalCost * 100).toFixed(1) : 0}%)` } }, datalabels: { display: true, formatter: (val, ctx) => { const p = val / totalCost; return p > 0.05 ? (p*100).toFixed(1)+'%' : '' }, color: '#fff', font: { weight: 'bold' } } } } });
        if (modePrefix === 'b') b_labor_chart = newChart; else f_labor_chart = newChart;
    };

    const updateCompositionChart = (modePrefix, data) => {
        const chartId = `${modePrefix}-composition-chart`;
        const ctx = document.getElementById(chartId).getContext('2d');
        let chartInstance = (modePrefix === 'b') ? b_composition_chart : f_composition_chart;
        const labels = ['人件費', '資材費', '倉庫利益', '自社利益'];
        const values = [data.labor, data.material, data.vendorProfit, data.ownProfit];
        const total = data.finalPrice;
        if (chartInstance) chartInstance.destroy();
        const newChart = new Chart(ctx, { type: 'pie', data: { labels, datasets: [{ data: values.map(v => Math.max(0,v)), backgroundColor: ['#3B82F6', '#F59E0B', '#EF4444', '#10B981'], borderColor: '#fff', borderWidth: 2 }] }, options: { animation: false, responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, title: { display: true, text: `最終請求額の構成 (合計: ${formatCurrency(total)})`, font: { size: 16 } }, tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatCurrency(values[ctx.dataIndex])} (${total > 0 ? (values[ctx.dataIndex] / total * 100).toFixed(1) : 0}%)` } }, datalabels: { display: true, formatter: (val, ctx) => { const p = values[ctx.dataIndex]/total; return p > 0.05 ? (p*100).toFixed(1)+'%' : '' }, color: '#fff', font: { weight: 'bold' } } } } });
        if (modePrefix === 'b') b_composition_chart = newChart; else f_composition_chart = newChart;
    };

    const recalculate = () => {
        if (!contentBackward.classList.contains('hidden')) {
            calculateBackward();
        } else if (!contentForward.classList.contains('hidden')) {
            calculateForward();
        }
    }

    const switchTab = (activeTab) => {
        const tabs = [tabForward, tabBackward, tabComparison];
        const contents = [contentForward, contentBackward, contentComparison];
        
        tabs.forEach((tab, index) => {
            const content = contents[index];
            if (tab === activeTab) {
                tab.classList.replace('tab-inactive', 'tab-active');
                content.classList.remove('hidden');
                if (tab === tabForward) appDescription.textContent = descriptions.forward;
                if (tab === tabBackward) appDescription.textContent = descriptions.backward;
                if (tab === tabComparison) appDescription.textContent = descriptions.comparison;
            } else {
                tab.classList.replace('tab-active', 'tab-inactive');
                content.classList.add('hidden');
            }
        });
        
        categorySettingsBtn.classList.toggle('hidden', activeTab !== tabComparison);
        
        recalculate(); 
    };

    const initialize = () => {
        versionInfo.textContent = 'Version 22.1';
        const initialProcesses = [{name: 'ピッキング', value: 30}, {name: '包装紙で包む', value: 60}, {name: 'リボンをかける', value: 45}, {name: '箱詰め・緩衝材', value: 30}];
        const initialMaterials = [{name: '包装紙・リボン', value: 25}, {name: '専用ダンボール', value: 20}];

        setupDetailItems('b', initialProcesses, initialMaterials);
        setupDetailItems('f', initialProcesses, initialMaterials);
        
        tabForward.addEventListener('click', () => switchTab(tabForward));
        tabBackward.addEventListener('click', () => switchTab(tabBackward));
        tabComparison.addEventListener('click', () => switchTab(tabComparison));

        document.body.addEventListener('input', (e) => {
            if(e.target.matches('#content-forward input, #content-backward input')){ recalculate(); }
        });
        document.body.addEventListener('click', (e) => {
            if(e.target.closest('.btn-clear-individual')){
                document.getElementById(e.target.closest('.btn-clear-individual').dataset.target).value = '';
                recalculate();
            }
        });
        
        tabForward.click();
    };
    
    return { initialize };
})();


// --- ここから フリー版 (比較分析モード) のスクリプト ---
const comparisonMode = (() => {
    let charts = { a: null, b: null, comparison: null };
    let categories = ['人件費', '資材費', '配送費', '固定費', '変動費', 'その他'];
    let tempCategories = [];

    const createModelUI = (containerId, modelId, modelSubName, initialItems) => {
        const container = document.getElementById(containerId);
        container.innerHTML = `
            <div class="flex items-baseline gap-2">
                <label for="model-${modelId}-subname" class="text-2xl font-bold text-gray-800 whitespace-nowrap">■ モデル${modelId.toUpperCase()}：</label>
                <input type="text" id="model-${modelId}-subname" class="text-2xl font-bold text-gray-800 w-full p-1 border-b-2 border-transparent focus:border-blue-500 outline-none bg-transparent" value="${modelSubName}">
            </div>
            <div class="border rounded-lg">
                <div id="toggle-items-${modelId}" class="flex justify-between items-center p-3 cursor-pointer bg-gray-50 hover:bg-gray-100 rounded-t-lg">
                    <h3 class="font-semibold text-gray-700">▼ コスト項目一覧</h3>
                </div>
                <div id="collapsible-section-${modelId}" class="transition-all duration-300">
                    <div class="p-4 pb-0">
                        <div class="flex items-center gap-2 text-sm font-semibold text-gray-500 mb-2">
                            <span style="width: 120px; flex-shrink: 0;">カテゴリ</span>
                            <span class="flex-grow">項目名</span>
                            <span class="text-right" style="width: 120px; flex-shrink: 0;">金額 (円)</span>
                            <span style="width: 2.5rem; flex-shrink: 0;"></span>
                        </div>
                        <div id="model-${modelId}-items" class="space-y-2 max-h-[20rem] overflow-y-auto pr-2"></div>
                    </div>
                    <div class="px-4 pb-4 border-t mt-4 pt-4">
                        <button type="button" id="add-item-${modelId}" class="btn-add">+ 項目を追加</button>
                    </div>
                </div>
            </div>
            <div class="total-card text-center">
                <p class="text-sm text-gray-600">合計コスト</p>
                <p id="total-cost-${modelId}" class="total-value">¥0</p>
            </div>
            <div><canvas id="chart-${modelId}"></canvas></div>`;
        
        const itemsContainer = document.getElementById(`model-${modelId}-items`);
        initialItems.forEach(item => addCostItem(itemsContainer, modelId, item.category, item.name, item.value));

        document.getElementById(`add-item-${modelId}`).addEventListener('click', () => { addCostItem(itemsContainer, modelId, categories[0], '', ''); calculateAndRedraw(); });
        document.getElementById(`model-${modelId}-subname`).addEventListener('input', () => calculateAndRedraw());
        document.getElementById(`toggle-items-${modelId}`).addEventListener('click', (e) => { document.getElementById(`collapsible-section-${modelId}`).classList.toggle('hidden'); });
    };

    const addCostItem = (container, modelId, category = '', name = '', value = '') => {
        const item = document.createElement('div');
        item.className = 'cost-item';
        const categoryOptions = categories.map(c => `<option value="${c}" ${c === category ? 'selected' : ''}>${c}</option>`).join('');
        item.innerHTML = `
            <select class="input-field item-category" style="width: 120px; flex-shrink: 0;">${categoryOptions}</select>
            <input type="text" class="input-field item-name flex-grow" placeholder="項目名" value="${name}">
            <input type="number" class="input-field item-value text-right" placeholder="金額" value="${value}" style="width: 120px; flex-shrink: 0;" step="500">
            <button type="button" class="btn-delete" style="flex-shrink: 0;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
            </button>`;
        container.appendChild(item);
        item.querySelectorAll('input, select').forEach(input => input.addEventListener('input', () => calculateAndRedraw()));
        item.querySelector('.btn-delete').addEventListener('click', () => { item.remove(); calculateAndRedraw(); });
    };

    const getCostData = (modelId) => {
        const items = Array.from(document.querySelectorAll(`#model-${modelId}-items .cost-item`));
        const costData = items.map(item => ({
            category: item.querySelector('.item-category').value,
            name: item.querySelector('.item-name').value || '無名の項目',
            value: parseFloat(item.querySelector('.item-value').value) || 0,
        })).filter(d => d.value > 0);
        const totalCost = costData.reduce((sum, item) => sum + item.value, 0);
        const categorized = costData.reduce((acc, item) => {
            acc[item.category] = (acc[item.category] || 0) + item.value;
            return acc;
        }, {});
        return { costData, totalCost, categorized };
    };

    const getModelFullName = (modelId) => {
        const modelLabel = `モデル${modelId.toUpperCase()}`;
        const modelSubName = document.getElementById(`model-${modelId}-subname`).value;
        return `${modelLabel}：${modelSubName}`;
    };

    const calculateAndRedraw = (whatIfParams = null) => {
        let modelA = getCostData('a');
        let modelB = getCostData('b');
        if (whatIfParams) {
            modelA = applyWhatIf(modelA, whatIfParams);
            modelB = applyWhatIf(modelB, whatIfParams);
        }
        document.getElementById('total-cost-a').textContent = formatCurrency(modelA.totalCost);
        updatePieChart('a', modelA.categorized, modelA.totalCost);
        document.getElementById('total-cost-b').textContent = formatCurrency(modelB.totalCost);
        updatePieChart('b', modelB.categorized, modelB.totalCost);
        updateComparisonSection(modelA, modelB);
    };

    const applyWhatIf = (modelData, params) => {
        const { categories, percentage, direction } = params;
        const multiplier = direction === 'increase' ? 1 + percentage / 100 : 1 - percentage / 100;
        const newCostData = modelData.costData.map(item => {
            if (categories.includes('全体') || categories.includes(item.category)) {
                return { ...item, value: item.value * multiplier };
            }
            return item;
        });
        const newTotalCost = newCostData.reduce((sum, item) => sum + item.value, 0);
        const newCategorized = newCostData.reduce((acc, item) => {
            acc[item.category] = (acc[item.category] || 0) + item.value;
            return acc;
        }, {});
        return { costData: newCostData, totalCost: newTotalCost, categorized: newCategorized };
    };

    const updatePieChart = (modelId, categorizedData, totalCost) => {
        const ctx = document.getElementById(`chart-${modelId}`).getContext('2d');
        if (charts[modelId]) charts[modelId].destroy();
        charts[modelId] = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(categorizedData), datasets: [{ data: Object.values(categorizedData), backgroundColor: ['#3B82F6', '#EF4444', '#F59E0B', '#10B981', '#8B5CF6', '#EC4899'], borderColor: '#fff', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, title: { display: true, text: `${getModelFullName(modelId)} のコスト構成`, font: { size: 16 } }, tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatCurrency(ctx.raw)} (${totalCost > 0 ? (ctx.parsed/totalCost*100).toFixed(1) : 0}%)` } }, datalabels: { display: true, formatter: (val, ctx) => { const p = val/totalCost; return p < 0.07 ? '' : (p*100).toFixed(1) + '%' }, color: '#fff', font: { weight: 'bold', size: 14 } } } } });
    };

    const updateComparisonSection = (modelA, modelB) => {
        const section = document.getElementById('comparison-section');
        section.classList.toggle('hidden', modelA.totalCost === 0 && modelB.totalCost === 0);
        if (section.classList.contains('hidden')) return;

        const summaryContainer = document.getElementById('comparison-summary');
        const diff = modelB.totalCost - modelA.totalCost;
        const percentageDiff = modelA.totalCost === 0 ? (diff > 0 ? 100 : 0) : (diff / modelA.totalCost) * 100;
        const diffClass = diff > 0 ? 'text-red-600' : diff < 0 ? 'text-blue-600' : 'text-gray-700';
        const diffSign = diff > 0 ? '+' : '';
        const resultText = diff > 0 ? `<p class="mt-3 text-lg font-bold text-blue-700">合計コストでは、モデルAが優れています。</p>` : diff < 0 ? `<p class="mt-3 text-lg font-bold text-red-700">合計コストでは、モデルBが優れています。</p>` : `<p class="mt-3 text-lg font-bold text-gray-700">両モデルの合計コストは同額です。</p>`;
        
        let summaryHTML = `<div class="text-center">
            <p class="text-lg font-semibold">合計コスト比較 (B - A)</p>
            <p class="text-4xl font-bold ${diffClass}">${diffSign}${formatCurrency(diff)}</p>
            <p class="text-lg font-semibold ${diffClass}">(${diffSign}${percentageDiff.toFixed(1)}%)</p>
            ${resultText}</div>
            <div class="mt-4 border-t pt-4"><p class="font-semibold text-center mb-2">カテゴリ別 差額内訳</p><div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm text-center">`;
        
        const allCategories = new Set([...Object.keys(modelA.categorized), ...Object.keys(modelB.categorized)]);
        allCategories.forEach(cat => {
            const valA = modelA.categorized[cat] || 0;
            const valB = modelB.categorized[cat] || 0;
            const catDiff = valB - valA;
            const catDiffClass = catDiff > 0 ? 'text-red-600' : catDiff < 0 ? 'text-blue-600' : 'text-gray-600';
            summaryHTML += `<div class="bg-white p-2 rounded-md cursor-pointer" title="モデルB: ${formatCurrency(valB)} - モデルA: ${formatCurrency(valA)}"><p class="font-bold">${cat}</p><p class="${catDiffClass} font-semibold">${catDiff>0?'+':''}${formatCurrency(catDiff)}</p></div>`;
        });
        summaryContainer.innerHTML = summaryHTML + '</div></div>';
        updateBarChart(modelA, modelB);
    };

    const updateBarChart = (modelA, modelB) => {
        const ctx = document.getElementById('comparison-chart').getContext('2d');
        if (charts.comparison) charts.comparison.destroy();
        const allCategories = Array.from(new Set([...Object.keys(modelA.categorized), ...Object.keys(modelB.categorized)]));
        charts.comparison = new Chart(ctx, { type: 'bar', data: { labels: allCategories, datasets: [ { label: getModelFullName('a'), data: allCategories.map(c => modelA.categorized[c]||0), backgroundColor: 'rgba(59, 130, 246, 0.7)', borderWidth: 1 }, { label: getModelFullName('b'), data: allCategories.map(c => modelB.categorized[c]||0), backgroundColor: 'rgba(239, 68, 68, 0.7)', borderWidth: 1 } ] }, options: { plugins: { tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.raw)}` } } }, scales: { y: { beginAtZero: true, ticks: { callback: val => formatCurrency(val) } } } } });
    };

    const openCategoryModal = () => { tempCategories = [...categories]; renderCategoryList(); document.getElementById('category-modal').classList.remove('hidden'); };
    const closeCategoryModal = () => document.getElementById('category-modal').classList.add('hidden');
    
    const renderCategoryList = () => {
        const list = document.getElementById('category-list');
        list.innerHTML = '';
        tempCategories.forEach((cat, index) => {
            const item = document.createElement('div');
            item.className = 'flex items-center gap-2';
            item.innerHTML = `<input type="text" value="${cat}" class="input-field flex-grow category-input" data-index="${index}"><button class="btn-delete" data-index="${index}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button>`;
            list.appendChild(item);
        });
        list.querySelectorAll('.category-input').forEach(i => i.addEventListener('change', e => { tempCategories[e.target.dataset.index] = e.target.value; }));
        list.querySelectorAll('.btn-delete').forEach(b => b.addEventListener('click', e => { tempCategories.splice(e.currentTarget.dataset.index, 1); renderCategoryList(); }));
    };

    const updateAllCategorySelects = () => {
        document.querySelectorAll('#content-comparison .item-category').forEach(select => {
            const currentVal = select.value;
            select.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
            if (categories.includes(currentVal)) select.value = currentVal;
        });
        const whatIfSelect = document.getElementById('what-if-category');
        const currentWhatIfVals = Array.from(whatIfSelect.selectedOptions).map(o => o.value);
        whatIfSelect.innerHTML = `<option value="全体">全体</option>` + categories.map(c => `<option value="${c}">${c}</option>`).join('');
        Array.from(whatIfSelect.options).forEach(o => { if (currentWhatIfVals.includes(o.value)) o.selected = true; });
    };

    const initialize = () => {
        const initialItemsA = [ { category: '人件費', name: '作業委託費', value: 150000 }, { category: '固定費', name: '倉庫保管料', value: 50000 }, { category: '配送費', name: '宅配便（平均）', value: 80000 }, { category: '変動費', name: '管理手数料', value: 20000 }, ];
        const initialItemsB = [ { category: '人件費', name: '自社スタッフ人件費', value: 180000 }, { category: '固定費', name: '事務所賃料（按分）', value: 30000 }, { category: '配送費', name: '宅配便（割引適用）', value: 75000 }, { category: '資材費', name: '梱包資材費', value: 25000 }, ];
        createModelUI('model-a-container', 'a', '外注プラン', initialItemsA);
        createModelUI('model-b-container', 'b', '内製プラン', initialItemsB);
        updateAllCategorySelects();
        calculateAndRedraw();
        document.getElementById('category-settings-btn').addEventListener('click', openCategoryModal);
        document.getElementById('cancel-categories-btn').addEventListener('click', closeCategoryModal);
        document.getElementById('add-category-btn').addEventListener('click', () => {
            const input = document.getElementById('new-category-name');
            if (input.value.trim()) { tempCategories.push(input.value.trim()); input.value = ''; renderCategoryList(); }
        });
        document.getElementById('save-categories-btn').addEventListener('click', () => {
            categories = [...tempCategories].filter(c => c.trim() !== '');
            updateAllCategorySelects(); calculateAndRedraw(); closeCategoryModal();
        });
        document.getElementById('what-if-apply').addEventListener('click', () => {
            const selectedCategories = Array.from(document.getElementById('what-if-category').selectedOptions).map(o => o.value);
            const percentage = parseFloat(document.getElementById('what-if-percentage').value);
            const direction = document.getElementById('what-if-direction').value;
            if (selectedCategories.length > 0 && !isNaN(percentage)) {
                calculateAndRedraw({ categories: selectedCategories, percentage, direction });
            }
        });
        document.getElementById('what-if-reset').addEventListener('click', () => {
            document.getElementById('what-if-percentage').value = '';
            document.getElementById('what-if-category').selectedIndex = -1;
            calculateAndRedraw();
        });
    };

    return { initialize };
})();


// --- アプリケーション全体の初期化 ---
window.addEventListener('load', () => {
    v21_2.initialize();
    comparisonMode.initialize();
});

</script>
</body>
</html>
